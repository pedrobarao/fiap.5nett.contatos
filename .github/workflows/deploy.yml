name: Deploy to AKS

on:
#  workflow_run:
#    workflows: [ "Build and Publish Docker Images" ]
#    types: [ completed ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
#    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      IMAGE_CADASTRO: pedrobaraof/fiap.5nett.contatos-cadastro
      IMAGE_CONSULTA: pedrobaraof/fiap.5nett.contatos-consulta
      TAG: latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      #      - name: Set TAG
      #        run: |
      #          if [ "${{ github.event.workflow_run.head_branch }}" = "main" ]; then
      #            echo "TAG=latest" >> $GITHUB_ENV
      #          else
      #            echo "TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
      #          fi

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v2
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Make apply script executable
        run: chmod +x deploy/k8s/apply.sh

      - name: Apply Kubernetes manifests (ordered via script)
        run: |
          if [ -f deploy/k8s/apply.sh ]; then
            ./deploy/k8s/apply.sh
          else
            echo "::error::`deploy/k8s/apply.sh` não encontrado"
            exit 1
          fi
          
      - name: Update images and trigger rollout
        shell: bash
        run: |
          set -Eeuo pipefail
          NS="contatos-app"
          # Força atualização das imagens (dispara rollout)
          kubectl -n "$NS" set image deploy/cadastro-contatos-api cadastro-contatos-api="${IMAGE_CADASTRO}:${TAG}"
          kubectl -n "$NS" set image deploy/consulta-contatos-api consulta-contatos-api="${IMAGE_CONSULTA}:${TAG}"
          
      - name: Wait for rollouts
        shell: bash
        run: |
          set -Eeuo pipefail
          NS="contatos-app"
          DEPLOYS=("cadastro-contatos-api" "consulta-contatos-api")
          dump() {
            local d="$1"
            echo "[DIAG] Deployment: $d"
            kubectl -n "$NS" get deploy "$d" -o wide || true
            kubectl -n "$NS" describe deploy "$d" || true
            echo "[DIAG] ReplicaSets (recentes):"
            kubectl -n "$NS" get rs --sort-by=.metadata.creationTimestamp -o wide | tail -n 5 || true
            local sel
            sel="$(kubectl -n "$NS" get deploy "$d" -o jsonpath='{range $k,$v := .spec.selector.matchLabels}{printf "%s=%s," $k $v}{end}' | sed 's/,$//' || true)"
            if [[ -n "$sel" ]]; then
              echo "[DIAG] Pods ($sel):"
              kubectl -n "$NS" get pods -l "$sel" -o wide || true
              kubectl -n "$NS" describe pods -l "$sel" || true
              for p in $(kubectl -n "$NS" get pods -l "$sel" --sort-by=.metadata.creationTimestamp -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' 2>/dev/null | tail -n 3); do
                echo "[DIAG] Logs (tail 200) do pod: $p"
                kubectl -n "$NS" logs "$p" --all-containers --tail=200 || true
              done
            fi
            echo "[DIAG] Eventos recentes:"
            kubectl -n "$NS" get events --sort-by=.metadata.creationTimestamp | tail -n 100 || true
          }
          for d in "${DEPLOYS[@]}"; do
            echo "Aguardando rollout de $d..."
            if ! kubectl -n "$NS" rollout status deploy "$d" --timeout=600s; then
              echo "::error::Rollout de $d falhou ou expirou"
              dump "$d"
              exit 1
            fi
          done
